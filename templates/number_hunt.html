<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>–û—Ö–æ—Ç–∞ –∑–∞ —Ü–∏—Ñ—Ä–∞–º–∏ ‚Äî –ù–∞–π–¥–∏ —Å—É–º–º—É</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #fdfdfd;
      margin: 0;
      padding: 30px;
      text-align: center;
    }

    h1 {
      color: #4a148c;
      margin-bottom: 10px;
    }

    .instructions {
      max-width: 600px;
      margin: 0 auto 20px;
      background-color: #fff3e0;
      border-left: 6px solid #ff9800;
      padding: 16px;
      border-radius: 8px;
    }

    .game-area {
      position: relative;
      width: 100%;
      max-width: 600px;
      height: 300px;
      margin: 0 auto 20px;
      background-color: #f0f0f0;
      border-radius: 12px;
      overflow: hidden;
      border: 2px dashed #ccc;
    }

    .number {
      position: absolute;
      font-size: 24px;
      font-weight: bold;
      background-color: #8a2be2;
      color: white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .form {
      margin-top: 10px;
    }

    input[type="number"] {
      padding: 10px;
      font-size: 16px;
      width: 100px;
      border: 2px solid #ccc;
      border-radius: 6px;
      text-align: center;
    }

    .btn {
      margin-left: 10px;
      padding: 10px 20px;
      font-weight: bold;
      border: none;
      background-color: #8a2be2;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }

    .btn:hover {
      background-color: #6d1cb3;
    }

    .btn-back {
      display: inline-block;
      margin-top: 30px;
      text-decoration: none;
      color: #8a2be2;
      font-weight: bold;
    }

    .result {
      font-weight: bold;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <h1>–û—Ö–æ—Ç–∞ –∑–∞ —Ü–∏—Ñ—Ä–∞–º–∏</h1>
  <div class="instructions">
    <p>–ö–∞–∫–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã –ø–æ–ª—É—á–∏—Ç–µ, —Å–ª–æ–∂–∏–≤ –≤—Å–µ –ø–µ—Ä–µ–¥–≤–∏–≥–∞—é—â–∏–µ—Å—è —á–∏—Å–ª–∞? –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –Ω–∞–±–ª—é–¥–∞–π—Ç–µ –∑–∞ —Ü–∏—Ñ—Ä–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –¥–≤–∏–≥–∞—é—Ç—Å—è –ø–æ —ç–∫—Ä–∞–Ω—É, –∏ –≤–≤–µ–¥–∏—Ç–µ –∏—Ö —Å—É–º–º—É –Ω–∏–∂–µ.</p>
  </div>

  <div class="game-area" id="gameArea"></div>

  <div class="form">
    <label>–°—É–º–º–∞: </label>
    <input type="number" id="userSum" />
    <button class="btn" onclick="checkSum()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
    <button class="btn" onclick="startGame()">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
  </div>

  <div id="result" class="result"></div>

  <a href="/" class="btn-back">‚Üê –ù–∞–∑–∞–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>

  <script>
    const gameArea = document.getElementById('gameArea');
    const resultText = document.getElementById('result');
    let totalSum = 0;
    let numbers = [];
    let interval;

    function getRandom(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function createNumber() {
      const numberEl = document.createElement('div');
      numberEl.className = 'number';
      const value = getRandom(1, 9);
      numberEl.innerText = value;

      let x = getRandom(0, gameArea.clientWidth - 40);
      let y = getRandom(0, gameArea.clientHeight - 40);
      let dx = getRandom(-2, 2) || 1;
      let dy = getRandom(-2, 2) || 1;

      numberEl.style.left = x + 'px';
      numberEl.style.top = y + 'px';
      gameArea.appendChild(numberEl);

      numbers.push({ el: numberEl, value, x, y, dx, dy });
      totalSum += value;
    }

    function moveNumbers() {
      numbers.forEach(obj => {
        obj.x += obj.dx;
        obj.y += obj.dy;

        if (obj.x <= 0 || obj.x >= gameArea.clientWidth - 40) obj.dx *= -1;
        if (obj.y <= 0 || obj.y >= gameArea.clientHeight - 40) obj.dy *= -1;

        obj.el.style.left = obj.x + 'px';
        obj.el.style.top = obj.y + 'px';
      });
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    function awardPoints() {
      fetch('/add_score/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ points: 20 }) // –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ
      })
      .then(res => res.json())
      .then(data => console.log('–ù–∞—á–∏—Å–ª–µ–Ω—ã –æ—á–∫–∏! –ù–æ–≤—ã–π —Å—á—ë—Ç:', data.new_score))
      .catch(err => console.error('–û—à–∏–±–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –æ—á–∫–æ–≤:', err));
    }

    function checkSum() {
      const userInput = parseInt(document.getElementById('userSum').value, 10);
      if (userInput === totalSum) {
        resultText.innerText = '–ü—Ä–∞–≤–∏–ª—å–Ω–æ! üéâ';
        awardPoints();  // üëâ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –æ—á–∫–æ–≤
      } else {
        resultText.innerText = `–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—É–º–º–∞: ${totalSum}`;
      }
    }

    function startGame() {
      clearInterval(interval);
      gameArea.innerHTML = '';
      resultText.innerText = '';
      document.getElementById('userSum').value = '';
      totalSum = 0;
      numbers = [];
      for (let i = 0; i < 6; i++) {
        createNumber();
      }
      interval = setInterval(moveNumbers, 30);
    }

    startGame();
  </script>
</body>
</html>
